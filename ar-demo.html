<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D Gaussian Splatting AR Demo V6 - gsplat.js</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        
        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            max-width: 300px;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            max-width: 90vw;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        button:hover {
            background: #0099ff;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .ar-btn {
            background: #ff6b35;
        }
        
        .ar-btn:hover {
            background: #ff8c42;
        }
        
        #progress {
            width: 120px;
            height: 5px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 0 5px;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #0088ff);
            width: 0%;
            transition: width 0.1s;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            color: #00ff88;
        }
        
        .error {
            color: #ff4444;
        }
        
        .info {
            font-size: 11px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .controls-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls-row {
                justify-content: center;
            }
            
            button {
                flex: 1;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="loading">
        <div class="spinner"></div>
        <div id="load-text">Loading gsplat.js...</div>
        <div id="load-progress">0/400</div>
    </div>
    
    <div id="ui">
        <div><strong>ðŸŽ¯ 4D Gaussian Splatting AR</strong></div>
        <div>Status: <span id="status" class="status">Loading...</span></div>
        <div>Frames: <span id="frame-count">0</span>/400</div>
        <div>Current: Frame <span id="current-frame">0</span></div>
        <div>Time: <span id="time-display">00:00/16:00</span></div>
        <div class="info">gsplat.js powered Gaussian Splatting</div>
        <div class="info">Proper PLY Gaussian rendering</div>
    </div>
    
    <div id="controls">
        <div class="controls-row">
            <button id="load-btn">Load PLY Sequence</button>
            <button id="play-btn" disabled>Play</button>
            <button id="pause-btn" disabled>Pause</button>
            <button id="reset-btn" disabled>Reset</button>
        </div>
        <div class="controls-row">
            <div id="progress">
                <div id="progress-fill"></div>
            </div>
            <span id="fps-display">25fps</span>
        </div>
    </div>

    <script type="module">
        console.log('ðŸš€ Starting gsplat.js AR Demo V6');
        
        // Import gsplat.js from CDN
        const SPLAT = await import('https://unpkg.com/gsplat@latest/dist/gsplat.module.js');
        console.log('âœ… gsplat.js loaded successfully');
        
        class GsplatARDemo {
            constructor() {
                console.log('Initializing Gsplat AR Demo...');
                
                // Core gsplat.js components
                this.canvas = document.getElementById('canvas');
                this.renderer = new SPLAT.WebGLRenderer(this.canvas);
                this.scene = new SPLAT.Scene();
                this.camera = new SPLAT.Camera();
                this.controls = new SPLAT.OrbitControls(this.camera, this.canvas);
                
                // Sequence data
                this.frames = []; // Array of loaded PLY splat objects
                this.currentTime = 0;
                this.totalTime = 16.0; // 16 seconds
                this.fps = 25;
                this.isPlaying = false;
                this.isLoading = false;
                this.currentFrameIndex = 0;
                
                // PLY URLs
                this.baseUrl = 'https://raw.githubusercontent.com/lumigrade/LumiAR/main/data/';
                this.totalFrames = 400;
                
                this.setupUI();
                this.setupRenderer();
                this.startRenderLoop();
                
                this.setStatus('Ready - Click Load PLY Sequence');
                document.getElementById('load-btn').disabled = false;
                this.hideLoading();
                
                console.log('âœ… Gsplat AR Demo initialized');
            }
            
            setupRenderer() {
                // Set up the renderer size
                this.handleResize();
                window.addEventListener('resize', () => this.handleResize());
                
                // Set initial camera position
                this.camera.position.set(0, 1, 3);
                this.controls.update();
            }
            
            handleResize() {
                this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
            }
            
            setupUI() {
                document.getElementById('load-btn').onclick = () => this.loadSequence();
                document.getElementById('play-btn').onclick = () => this.play();
                document.getElementById('pause-btn').onclick = () => this.pause();
                document.getElementById('reset-btn').onclick = () => this.reset();
                
                // File drop support
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (e.dataTransfer?.files.length > 0) {
                        this.loadFromFiles(e.dataTransfer.files);
                    }
                });
            }
            
            async loadSequence() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                this.showLoading();
                this.setStatus('Loading PLY sequence from GitHub...');
                document.getElementById('load-btn').disabled = true;
                
                console.log(`ðŸ”„ Starting to load ${this.totalFrames} PLY files...`);
                
                try {
                    this.frames = [];
                    let loadedCount = 0;
                    
                    // Load PLY files sequentially for better memory management
                    for (let i = 1; i <= this.totalFrames; i++) {
                        const frameNum = i.toString().padStart(6, '0');
                        const url = `${this.baseUrl}compressed_frame_${frameNum}.ply`;
                        
                        document.getElementById('load-progress').textContent = `${i}/${this.totalFrames}`;
                        document.getElementById('load-text').textContent = `Loading frame ${i}...`;
                        
                        try {
                            console.log(`ðŸ“ Loading frame ${i}: ${url}`);
                            
                            // Create a temporary scene for this frame
                            const tempScene = new SPLAT.Scene();
                            
                            // Load PLY directly using gsplat.js PLYLoader
                            await this.loadPLYFromURL(url, tempScene);
                            
                            // Store the loaded splat object
                            if (tempScene.objects.length > 0) {
                                this.frames.push({
                                    index: i - 1,
                                    timestamp: (i - 1) / (this.totalFrames - 1) * this.totalTime,
                                    splat: tempScene.objects[0] // The loaded splat object
                                });
                                loadedCount++;
                                
                                // Show first frame immediately
                                if (i === 1) {
                                    this.showFrame(0);
                                }
                                
                                console.log(`âœ… Frame ${i} loaded (${tempScene.objects[0].data.vertexCount} gaussians)`);
                            } else {
                                console.warn(`âš ï¸ Frame ${i} loaded but has no objects`);
                            }
                            
                            // Update UI every 25 frames
                            if (i % 25 === 0) {
                                document.getElementById('frame-count').textContent = loadedCount;
                                this.updateTimeDisplay();
                                await new Promise(resolve => setTimeout(resolve, 1));
                            }
                            
                        } catch (error) {
                            if (i === 1) {
                                throw new Error(`Cannot load first frame: ${error.message}`);
                            }
                            console.log(`â¹ï¸ Stopped at frame ${i}: ${error.message}`);
                            break;
                        }
                    }
                    
                    if (this.frames.length === 0) {
                        throw new Error('No PLY frames loaded successfully');
                    }
                    
                    console.log(`ðŸŽ‰ Successfully loaded ${this.frames.length} PLY frames`);
                    
                    document.getElementById('frame-count').textContent = this.frames.length;
                    this.setStatus(`Loaded ${this.frames.length} PLY frames - Ready to play`);
                    
                    // Enable controls
                    document.getElementById('play-btn').disabled = false;
                    document.getElementById('pause-btn').disabled = true;
                    document.getElementById('reset-btn').disabled = false;
                    
                } catch (error) {
                    console.error('âŒ Loading failed:', error);
                    this.setStatus(`Error: ${error.message}`, true);
                } finally {
                    this.hideLoading();
                    document.getElementById('load-btn').disabled = false;
                    this.isLoading = false;
                }
            }
            
            async loadPLYFromURL(url, targetScene) {
                // Fetch the PLY file
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Convert to blob for gsplat.js loader
                const blob = await response.blob();
                const file = new File([blob], 'frame.ply', { type: 'application/octet-stream' });
                
                // Use gsplat.js PLYLoader
                await SPLAT.PLYLoader.LoadFromFileAsync(
                    file,
                    targetScene,
                    (progress) => {
                        // Progress callback - optional
                    },
                    "" // format - empty for default
                );
            }
            
            async loadFromFiles(files) {
                const plyFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.ply'));
                if (plyFiles.length === 0) {
                    this.setStatus('No PLY files found in selection', true);
                    return;
                }
                
                this.showLoading();
                this.setStatus(`Loading ${plyFiles.length} PLY files...`);
                
                try {
                    this.frames = [];
                    
                    for (let i = 0; i < plyFiles.length; i++) {
                        const file = plyFiles[i];
                        document.getElementById('load-progress').textContent = `${i+1}/${plyFiles.length}`;
                        document.getElementById('load-text').textContent = `Loading ${file.name}...`;
                        
                        const tempScene = new SPLAT.Scene();
                        await SPLAT.PLYLoader.LoadFromFileAsync(file, tempScene);
                        
                        if (tempScene.objects.length > 0) {
                            this.frames.push({
                                index: i,
                                timestamp: i / (plyFiles.length - 1) * this.totalTime,
                                splat: tempScene.objects[0]
                            });
                        }
                    }
                    
                    if (this.frames.length > 0) {
                        this.showFrame(0);
                        document.getElementById('frame-count').textContent = this.frames.length;
                        document.getElementById('play-btn').disabled = false;
                        document.getElementById('reset-btn').disabled = false;
                        this.setStatus(`Loaded ${this.frames.length} PLY files`);
                    }
                    
                } catch (error) {
                    console.error('File loading failed:', error);
                    this.setStatus(`Error: ${error.message}`, true);
                } finally {
                    this.hideLoading();
                }
            }
            
            showFrame(frameIndex) {
                if (frameIndex < 0 || frameIndex >= this.frames.length) return;
                
                // Clear current scene
                this.scene.reset();
                
                // Add the frame's splat to the scene
                const frame = this.frames[frameIndex];
                this.scene.addObject(frame.splat);
                
                this.currentFrameIndex = frameIndex;
                document.getElementById('current-frame').textContent = frameIndex;
            }
            
            getCurrentFrameIndex() {
                if (this.frames.length === 0) return 0;
                
                // Calculate which frame should be showing based on current time
                const progress = this.currentTime / this.totalTime;
                const frameIndex = Math.floor(progress * (this.frames.length - 1));
                return Math.max(0, Math.min(frameIndex, this.frames.length - 1));
            }
            
            play() {
                if (this.frames.length === 0) return;
                
                this.isPlaying = true;
                document.getElementById('play-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                this.setStatus('Playing 4D Gaussian Splatting sequence');
                console.log('â–¶ï¸ Playing sequence');
            }
            
            pause() {
                this.isPlaying = false;
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                this.setStatus('Paused');
                console.log('â¸ï¸ Paused');
            }
            
            reset() {
                this.isPlaying = false;
                this.currentTime = 0;
                document.getElementById('play-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                
                if (this.frames.length > 0) {
                    this.showFrame(0);
                }
                
                this.updateTimeDisplay();
                this.setStatus('Reset to beginning');
                console.log('âª Reset');
            }
            
            updateTimeDisplay() {
                const minutes = Math.floor(this.currentTime / 60);
                const seconds = Math.floor(this.currentTime % 60);
                const totalMinutes = Math.floor(this.totalTime / 60);
                const totalSeconds = Math.floor(this.totalTime % 60);
                
                document.getElementById('time-display').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}/` +
                    `${totalMinutes.toString().padStart(2, '0')}:${totalSeconds.toString().padStart(2, '0')}`;
                
                const progress = (this.currentTime / this.totalTime) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
            }
            
            startRenderLoop() {
                const frame = () => {
                    // Update animation
                    if (this.isPlaying && this.frames.length > 0) {
                        this.currentTime += 1 / 60; // 60fps render loop
                        
                        if (this.currentTime >= this.totalTime) {
                            this.currentTime = 0; // Loop
                        }
                        
                        // Update to correct frame
                        const targetFrameIndex = this.getCurrentFrameIndex();
                        if (targetFrameIndex !== this.currentFrameIndex) {
                            this.showFrame(targetFrameIndex);
                        }
                        
                        this.updateTimeDisplay();
                    }
                    
                    // Update controls and render
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                    
                    requestAnimationFrame(frame);
                };
                
                requestAnimationFrame(frame);
                console.log('ðŸ”„ Render loop started');
            }
            
            setStatus(message, isError = false) {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = isError ? 'error' : 'status';
            }
            
            showLoading() {
                document.getElementById('loading').style.display = 'block';
            }
            
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Initialize the app
        try {
            console.log('ðŸŽ¬ Creating Gsplat AR Demo instance...');
            new GsplatARDemo();
            console.log('ðŸŽ‰ Gsplat AR Demo started successfully!');
        } catch (error) {
            console.error('ðŸ’¥ Failed to start Gsplat AR Demo:', error);
            document.getElementById('status').textContent = 'Failed to start: ' + error.message;
            document.getElementById('status').className = 'error';
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>