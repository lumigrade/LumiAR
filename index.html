<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4D Gaussian Splatting Viewer</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: sans-serif;
        }

        canvas {
            width: 100vw;
            height: 100vh;
        }

        dialog {
            width: 100%;
            text-align: center;
            max-width: 20em;
            color: white;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 8px;
            position: relative;
            transform: translate(-50%, -50%);
        }

        #progress-container {
            position: absolute;
            top: 50%;
            left: 50%;
        }

        progress {
            width: 100%;
            height: 1em;
            border: none;
            background-color: #333;
            color: #eee;
            border-radius: 4px;
        }

        progress::-webkit-progress-bar {
            background-color: #333;
            border-radius: 4px;
        }

        progress::-webkit-progress-value {
            background-color: #667eea;
            border-radius: 4px;
        }

        progress::-moz-progress-bar {
            background-color: #667eea;
            border-radius: 4px;
        }

        .file-selector {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #333;
            color: white;
        }

        .file-btn {
            display: block;
            width: 100%;
            padding: 15px 25px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .file-btn:hover {
            transform: translateY(-2px);
        }

        .file-btn.example {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .controls-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            max-width: 200px;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            z-index: 999;
            border: 3px dashed #667eea;
            margin: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="file-selector" id="fileSelector">
        <h2>üé¨ 4D Gaussian Splatting Viewer</h2>
        <p>Choose a .splatv file to load:</p>
        <button class="file-btn" onclick="loadYourFile()">
            üéØ Load Your File<br>
            <small>./data/splat-animation.splatv</small>
        </button>
        <button class="file-btn example" onclick="loadExample()">
            ‚úÖ Load Working Example<br>
            <small>flame.splatv (HuggingFace)</small>
        </button>
        <p style="font-size: 11px; opacity: 0.7; margin-top: 20px;">
            Or drag & drop a .splatv file anywhere
        </p>
    </div>

    <div class="controls-info hidden" id="controlsInfo">
        <h4>üéÆ Controls:</h4>
        <p><strong>Mouse:</strong> Orbit camera<br>
        <strong>Scroll:</strong> Zoom in/out<br>
        <strong>Drag:</strong> Pan view</p>
        <p style="margin-top: 10px; font-size: 10px; opacity: 0.7;">
            Press H to hide this panel
        </p>
    </div>

    <div id="progress-container" class="hidden">
        <dialog id="progress-dialog">
            <p>
                <label for="progress-indicator">Loading scene...</label>
            </p>
            <progress max="100" id="progress-indicator"></progress>
        </dialog>
    </div>

    <div class="drop-zone hidden" id="dropZone">
        üìÅ Drop your .splatv file here
    </div>

    <canvas id="canvas"></canvas>

    <script type="module">
        // Import gsplat.js from CDN (official v1.2.0)
        import * as SPLAT from 'https://cdn.jsdelivr.net/npm/gsplat@1.2.0/dist/gsplat.js';

        const canvas = document.getElementById("canvas");
        const progressDialog = document.getElementById("progress-dialog");
        const progressIndicator = document.getElementById("progress-indicator");
        const fileSelector = document.getElementById("fileSelector");
        const controlsInfo = document.getElementById("controlsInfo");
        const dropZone = document.getElementById("dropZone");

        const renderer = new SPLAT.WebGLRenderer(canvas);
        renderer.addProgram(new SPLAT.VideoRenderProgram(renderer));

        const scene = new SPLAT.Scene();
        const camera = new SPLAT.Camera();
        const controls = new SPLAT.OrbitControls(camera, canvas);

        let loading = false;

        // File loading function
        async function selectFile(file) {
            if (loading) return;
            loading = true;
            
            try {
                if (file.name.endsWith(".splatv") || file.name.includes("splatv")) {
                    scene.reset();
                    showProgress();
                    
                    await SPLAT.SplatvLoader.LoadFromFileAsync(file, scene, camera, (progress) => {
                        progressIndicator.value = progress * 100;
                    });
                    
                    hideProgress();
                    showControls();
                    console.log("‚úÖ File loaded successfully:", file.name);
                } else {
                    alert("Please select a .splatv file");
                }
            } catch (error) {
                hideProgress();
                alert("Error loading file: " + error.message);
                console.error("Loading error:", error);
            }
            
            loading = false;
        }

        // URL loading function
        async function loadFromUrl(url, name) {
            if (loading) return;
            loading = true;
            
            try {
                scene.reset();
                showProgress();
                
                await SPLAT.SplatvLoader.LoadAsync(url, scene, camera, (progress) => {
                    progressIndicator.value = progress * 100;
                });
                
                controls.setCameraTarget(camera.position.add(camera.forward.multiply(5)));
                hideProgress();
                showControls();
                console.log("‚úÖ URL loaded successfully:", name);
            } catch (error) {
                hideProgress();
                alert("Error loading from URL: " + error.message);
                console.error("URL loading error:", error);
            }
            
            loading = false;
        }

        // UI Functions
        function showProgress() {
            fileSelector.classList.add('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            progressDialog.showModal();
        }

        function hideProgress() {
            document.getElementById('progress-container').classList.add('hidden');
            progressDialog.close();
        }

        function showControls() {
            controlsInfo.classList.remove('hidden');
        }

        // Button handlers
        window.loadYourFile = function() {
            loadFromUrl('./data/splat-animation.splatv', 'Your .splatv file');
        };

        window.loadExample = function() {
            loadFromUrl('https://huggingface.co/datasets/dylanebert/3dgs/resolve/main/4d/flame/flame.splatv', 'Flame example');
        };

        // Drag & Drop support
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hidden');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.clientX === 0 && e.clientY === 0) {
                dropZone.classList.add('hidden');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.add('hidden');
            
            if (e.dataTransfer && e.dataTransfer.files.length > 0) {
                selectFile(e.dataTransfer.files[0]);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'h') {
                controlsInfo.classList.toggle('hidden');
            }
        });

        // Render loop
        function startRenderLoop() {
            const handleResize = () => {
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            };

            const frame = () => {
                controls.update();
                renderer.render(scene, camera);
                requestAnimationFrame(frame);
            };

            handleResize();
            window.addEventListener("resize", handleResize);
            requestAnimationFrame(frame);
        }

        // Auto-load example if URL parameter exists
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');
            
            if (url) {
                console.log('Auto-loading from URL parameter:', url);
                if (url.includes('flame')) {
                    loadExample();
                } else {
                    loadFromUrl(url, url.split('/').pop());
                }
            }
            
            // Start render loop
            startRenderLoop();
        }

        // Initialize
        init();
    </script>
</body>
</html>